<!DOCTYPE html>
<html>
<head>

<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/async.min.js"></script>
<script src="/demo/api.js"></script>
<script src="/demo/viewer.js"></script>
<script src="/demo/chaosbot.js"></script>
<script src="/demo/cleanupbot.js"></script>
<style>

    body {
        padding: 0px;
        margin: 0px;
    }

    #controls {
        position: absolute;
        padding: 5px;
    }

    #viewer {
        height: 100%;
        width: 100%;
        display: block;
        position: absolute;
    }

    canvas.viewer {
        border: solid 1px black;
        position: absolute;
        top: 5px;
        left: 150px;
    }

</style>
<script>
    $(function() {

        var bots = []

        // first, get the world
        $.get("/game", function(gameInfo) {
            var tickInterval = gameInfo.msTickInterval
            var worldInfo = gameInfo.worldFieldInfo
            var viewer = new Viewer($("#viewer"), worldInfo.fieldSize)

            var units = {}

            function tick() {
                $.get("/world/locations", function(locations) {

                    var unknownUnits = locations.filter(function(l) {
                        return !units[l.unitId]
                    }).map(function(l) {
                        return l.unitId
                    })

                    async.forEach(unknownUnits, function(unitId, done) {
                        units[unitId] = {} // so we don't fetch them twice
                        getUnitDescription(unitId, function(d) {
                            units[unitId] = d
                            done()
                        })
                    }, function() {

                    })

                    viewer.draw(locations, units)
                    for (var i = 0; i < bots.length; i++) {
                        bots[i].tick(locations, units)
                    }
                })
            }

            tick()
            var interval = setInterval(tick, tickInterval)

            $("#ChaosBot").click(function() {
                spawn(ChaosBot)
            })

            $("#CleanupBot").click(function() {
                spawn(CleanupBot)
            })

            function spawn(Class) {
                var bot = new Class(worldInfo, $("#color").val())
                bot.start()
                bots.push(bot)
            }

            function getUnitDescription(unitId, cb) {
                $.get("/units/" + unitId + "/description", function(description) {
                    cb(description)
                })
            }
        })


    })
</script>

</head>
<body>
    <div id="viewer">
    </div>
    <div id="controls">
        <div>Color</div>
        <div><input name="color" id="color" value="#000"></input></div>
        <div><button id="ChaosBot">ChaosBot</button></div>
        <div><button id="CleanupBot">CleanupBot</button></div>
    </div>
</body>
